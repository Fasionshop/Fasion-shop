<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fasion - Shop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* --- (CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) --- */
    :root { --primary: #7A56D3; --bg: #f5f5f5; --white: #ffffff; --text: #333; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å */
    body { 
      font-family: 'Mitr', sans-serif; background-color: var(--bg); 
      margin: 0; padding-bottom: 70px; font-size: 16px; 
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    header { background: linear-gradient(-180deg, #7A56D3, #5E42A6); padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏•‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö */
    .search-bar { flex-grow: 1; background: white; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; }
    .search-bar input { border: none; outline: none; width: 100%; margin-left: 10px; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    .icon-btn { color: white; font-size: 1.4rem; position: relative; cursor: pointer; display: flex; align-items: center; }
    .cart-badge { position: absolute; top: -8px; right: -8px; background: #ffe13c; color: var(--primary); font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; font-weight: bold; border: 1px solid var(--primary); } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .profile-menu { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-left: 5px; color: white; }
    .header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid white; background: #eee; }
    .header-name { font-size: 0.9rem; font-weight: 600; max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .category-bar { display: flex; overflow-x: auto; background: white; padding: 10px; gap: 15px; position: sticky; top: 60px; z-index: 90; }
    .cat-item { white-space: nowrap; padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; color: #666; transition: 0.3s; }
    .cat-item.active { border-color: var(--primary); color: var(--primary); background-color: #F3F0FF; font-weight: 600; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
    .product-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
    @media (max-width: 768px) { .product-container { grid-template-columns: repeat(2, 1fr); } }
    .product-card { background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; animation: fadeIn 0.5s; position: relative; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .p-img { width: 100%; aspect-ratio: 1 / 1; background-color: #ddd; object-fit: cover; }
    .p-details { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .p-name { font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px; }
    .p-price { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
    .p-stock { font-size: 0.75rem; color: #888; margin-top: 5px; }
    .p-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 8px; margin-top: 10px; border-radius: 3px; cursor: pointer; font-family: 'Mitr'; }
    .p-btn:disabled { background: #ccc; }
    .fav-btn { position: absolute; top: 8px; right: 8px; width: 35px; height: 35px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #ccc; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; border: none; z-index: 2; }
    .fav-btn:hover { transform: scale(1.1); }
    .fav-btn.active { color: #ff424f; } /* (‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ç‡∏≠‡∏á '‡∏ä‡∏≠‡∏ö' ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
    .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .confirm-modal-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 90%; max-width: 350px; animation: popIn 0.3s; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .confirm-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .confirm-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
    .confirm-desc { font-size: 0.95rem; color: #666; margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm-action { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Mitr'; font-weight: 600; }
    .btn-yes { background: var(--primary); color: white; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .btn-no { background: #eee; color: #333; }
    .btn-ok { background: #4CAF50; color: white; width: 100%; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
    .cart-item-info { flex-grow: 1; }
    .cart-item-controls { display: flex; align-items: center; gap: 10px; }
    .mini-qty-box { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; width: fit-content; }
    .mini-qty-btn { width: 25px; height: 25px; border: none; background: #f8f8f8; cursor: pointer; color: #555; display: flex; align-items: center; justify-content: center; }
    .mini-qty-btn:hover { background: #eee; }
    .mini-qty-val { width: 30px; text-align: center; font-size: 1rem; font-weight: 600; }
    .close-btn { float: right; font-size: 1.5rem; cursor: pointer; }
    .checkout-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; font-size: 1.2rem; margin-top: 15px; border-radius: 5px; font-family: 'Mitr', sans-serif; font-weight: 600; }
    .order-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff; }
    .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
    .order-status { font-weight: 600; color: var(--primary); }
    .order-items { font-size: 0.95rem; color: #333; }
    .order-total { text-align: right; font-weight: 600; font-size: 1.2rem; color: var(--primary); margin-top: 10px; }
    .item-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .chat-btn { position: fixed; bottom: 80px; right: 20px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: grab; z-index: 1000; font-size: 24px; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .chat-window { display: none; position: fixed; bottom: 150px; right: 20px; width: 300px; height: 400px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 10px; flex-direction: column; z-index: 1000; overflow: hidden; font-family: 'Mitr'; }
    .chat-header { background: var(--primary); color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: grab; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
    .chat-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-family: 'Mitr'; }
    .chat-input-area button { background: var(--primary); color: white; border: none; padding: 8px 15px; margin-left: 5px; border-radius: 20px; cursor: pointer; font-family: 'Mitr'; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 1rem; }
    .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .msg-admin { background: #e0e0e0; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
    #toast { visibility: hidden; min-width: 200px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1rem; opacity: 0; transition: opacity 0.3s, visibility 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    #toast.show { visibility: visible; opacity: 1; }
    #toast.error { background-color: rgba(220, 53, 69, 0.9); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color:#555; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    .payment-options label { display: block; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; cursor: pointer; display:flex; align-items:center; gap:10px; }
    .payment-options input:checked + span { color: var(--primary); font-weight: 600; }
    #bankDetails { display: none; background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; margin-top: 10px; animation: fadeIn 0.3s; }
    .bank-select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd; font-family: 'Mitr'; }
    #qrCodeContainer { text-align: center; margin-top: 10px; display: none; }
    #qrCodeContainer img { width: 200px; border: 1px solid #ddd; border-radius: 10px; }
    .bank-info { font-size: 1rem; color: #555; text-align: center; margin-top: 5px; }
    .qty-selector { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
    .qty-btn { width: 40px; height: 40px; border: 1px solid #ddd; background: white; font-size: 1.2rem; cursor: pointer; color: #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
    .qty-display { width: 60px; text-align: center; font-size: 1.2rem; font-weight: 600; border: none; font-family: 'Mitr'; }
    .modal-product-img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
    .modal-product-info { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .fav-item-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .empty-fav { grid-column: span 2; text-align: center; color: #999; padding: 20px; }
    .profile-header-edit { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .profile-img-large { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #eee; margin-bottom: 10px; }
    .upload-label { cursor: pointer; color: var(--primary); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; background: #F3F0FF; padding: 5px 15px; border-radius: 20px; transition: 0.2s; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .upload-label:hover { background: #E9E4FF; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .logout-btn { width: 100%; background: #eee; color: #333; margin-top: 10px; font-family: 'Mitr'; font-weight:600; }
  </style>
</head>
<body>

  <header>
    <div class="search-bar">
      <i class="fas fa-search" style="color: #666;"></i>
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="filterProducts()">
    </div>
    <div class="icon-btn" onclick="openFav()" title="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö"><i class="fas fa-heart"></i></div>
    <div class="icon-btn" onclick="openHistory()" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"><i class="fas fa-history"></i></div>
    <div class="icon-btn" onclick="openCart()" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"><i class="fas fa-shopping-cart"></i><span class="cart-badge" id="cartCount">0</span></div>
    <div id="authContainer">
       <div id="loginBtn" onclick="window.location.href='index.html'" style="margin-left:5px; color:white; font-size:1rem; cursor:pointer; white-space: nowrap; display:none;">
         <i class="fas fa-user-circle"></i> Login
       </div>
       <div id="userProfileBtn" class="profile-menu" onclick="openProfileModal()" style="display:none;">
         <img src="https://via.placeholder.com/50" class="header-avatar" id="headerAvatar">
         <span class="header-name" id="headerName">User</span>
       </div>
    </div>
  </header>

  <div class="category-bar" id="categoryBar">
    <div class="cat-item active" onclick="filterCategory('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô', this)">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡∏ú‡∏ä/‡∏ú‡∏ç</div>
    <div class="cat-item" onclick="filterCategory('‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á', this)">‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ú‡∏ä/‡∏ú‡∏ç</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î', this)">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', this)">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
  </div>

  <div id="toast"><i class="fas fa-check-circle"></i> <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></div>
  <div class="product-container" id="productList"><p style="width:100%; text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('profileModal')">&times;</span>
      <h2>üë§ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
      
      <div class="profile-header-edit">
        <img src="https://via.placeholder.com/100" class="profile-img-large" id="editAvatarPreview">
        <label for="fileInput" class="upload-label">
          <i class="fas fa-camera"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        </label>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="previewImage(event)">
      </div>
      
      <div class="form-group">
        <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="text" id="editEmail" class="form-control" disabled style="background:#f9f9f9; color:#888;">
      </div>
      
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</label>
        <input type="text" id="editName" class="form-control" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
      </div>

      <button class="checkout-btn" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
      <button class="checkout-btn logout-btn" onclick="closeModal('profileModal'); openLogoutConfirm()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <div id="qtyModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close-btn" onclick="closeModal('qtyModal')">&times;</span>
      <h3 style="margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
      <div class="modal-product-info">
        <img id="qtyImg" class="modal-product-img" src="">
        <div><div id="qtyName" style="font-weight:bold; margin-bottom:5px;"></div><div id="qtyPrice" style="color:var(--primary);"></div><div id="qtyStock" style="font-size:0.9rem; color:#888;"></div></div>
      </div>
      <div class="qty-selector">
        <button class="qty-btn" onclick="changeQty(-1)"><i class="fas fa-minus"></i></button>
        <input type="text" id="qtyDisplay" class="qty-display" value="1" readonly>
        <button class="qty-btn" onclick="changeQty(1)"><i class="fas fa-plus"></i></button>
      </div>
      <button class="checkout-btn" onclick="submitToCart()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    </div>
  </div>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('cartModal')">&times;</span>
      <h2>üõí ‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div id="cartItemsContainer"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p></div>
      
      <div class="coupon-box" style="margin-top: 15px; display:flex; gap:10px;">
        <input type="text" id="couponInput" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" style="margin:0; font-family:'Mitr';">
        <button id="couponBtn" onclick="applyCoupon()" style="width:auto; padding: 0 20px; font-size: 1rem; margin:0; font-family:'Mitr';">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
      </div>

      <div style="margin-top: 20px; border-top: 2px dashed #ddd; padding-top:10px; font-size:1rem; display:flex; flex-direction:column; gap: 5px;">
        <div style="display:flex; justify-content:space-between;">
          <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Subtotal)</span>
          <span id="subTotalPrice">‡∏ø0</span>
        </div>
        
        <div id="discountDisplay" style="display:flex; justify-content:space-between; color:green; display:none;">
          <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (<span id="couponCodeDisplay"></span>)</span>
          <span id="discountAmount"></span>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:600; margin-top:5px;">
          <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
          <span id="totalPrice" style="color:var(--primary)">‡∏ø0</span>
        </div>
      </div>
      
      <button class="checkout-btn" onclick="openPayment()">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>
  </div>
  
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('paymentModal')">&times;</span>
      <h2>üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
      <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
        <h3 style="font-size:1.1rem; color:var(--primary);">1. ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3> <div class="form-group"><input type="text" id="custName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"></div>
        <div class="form-group"><input type="tel" id="custPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"></div>
        <div class="form-group"><textarea id="custAddress" class="form-control" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á..."></textarea></div>
      </div>
      <div>
        <h3 style="font-size:1.1rem; color:var(--primary);">2. ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3> <div class="payment-options">
          <label onclick="toggleBank(false)"><input type="radio" name="payment" value="cod" checked> <span><i class="fas fa-truck"></i> ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</span></label>
          <label onclick="toggleBank(true)"><input type="radio" name="payment" value="bank"> <span><i class="fas fa-university"></i> ‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / QR</span></label>
          <div id="bankDetails">
             <p style="font-size:0.95rem; margin-bottom:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</p>
             <select id="bankSelect" class="bank-select" onchange="showQR()">
               <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
               <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
               <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
               <option value="promptpay">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option>
             </select>
             <div id="qrCodeContainer">
               <img id="qrImage" src="" alt="QR Code">
               <div class="bank-info" id="bankInfoText"></div>
               <div style="color:red; font-size:0.9rem; margin-top:5px;">*‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
             </div>
          </div>
        </div>
      </div>
      <button class="checkout-btn" id="confirmPayBtn" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('historyModal')">&times;</span>
      <h2>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <div id="historyContainer" style="margin-top:20px;"><p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
    </div>
  </div>

  <div id="favModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('favModal')">&times;</span>
      <h2>‚ù§Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</h2>
      <div id="favContainer" class="fav-item-grid" style="margin-top:20px;"></div>
    </div>
  </div>

  <div id="confirmModal" class="modal" style="align-items: center;">
    <div class="confirm-modal-box">
      <div id="confirmIcon" class="confirm-icon">‚ùì</div>
      <div id="confirmTitle" class="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?</div>
      <div id="confirmDesc" class="confirm-desc">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-no" onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm-action btn-yes" id="btnConfirmAction">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <div id="successModal" class="modal" style="align-items: center;">
    <div class="confirm-modal-box">
      <div class="confirm-icon" style="color:#4CAF50;"><i class="fas fa-check-circle"></i></div>
      <div class="confirm-title">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div class="confirm-desc">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-ok" onclick="closeModal('successModal')">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <div class="chat-btn" id="chatBtn"><i class="fas fa-comments"></i></div>
  <div class="chat-window" id="chatWindow">
    <div class="chat-header"><span>üí¨ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</span><span style="cursor:pointer" onclick="toggleChat()">&times;</span></div>
    <div class="chat-body" id="chatBody"><div class="msg msg-admin">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?</div></div>
    <div class="chat-input-area">
      <input type="text" id="msgInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleEnter(event)">
      <button onclick="sendMsg()">‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <script>
    // --- (JavaScript ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7lELq82KxJ0sFDf6jKmWPDFKpKqHJp0c",
      authDomain: "king007-c72e2.firebaseapp.com",
      projectId: "king007-c72e2",
      storageBucket: "king007-c72e2.firebasestorage.app",
      messagingSenderId: "136587774092",
      appId: "1:136587774092:web:4ee67ff03cdee67bb393a9",
      measurementId: "G-K39CYF7766"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- ‚õî ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‚õî ---
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      showToast('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', true); 
    });
    // --- ‚õî --------------------------- ‚õî ---

    let allProducts=[], cart=[], userFavorites=[];
    let currentSelectedId=null, currentQty=1;
    
    // üî• 2. JS: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô üî•
    let subtotalAmount = 0;
    let discountApplied = 0;
    let finalTotalAmount = 0;
    let currentDiscount = { code: null, type: null, value: 0 }; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
    
    let userId = localStorage.getItem('shop_userId');
    if (!userId) { userId = 'guest_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('shop_userId', userId); }

    window.onload = async () => {
      auth.onAuthStateChanged(async user => {
        if (user) {
          userId = user.uid;
          document.getElementById('loginBtn').style.display = 'none';
          document.getElementById('userProfileBtn').style.display = 'flex';
          
          listenToChat();
          loadFavorites();
          await loadUserProfile(user); 
        } else {
          document.getElementById('loginBtn').style.display = 'block';
          document.getElementById('userProfileBtn').style.display = 'none';
          listenToChat();
        }
      });
      await checkAndSeedData(); // (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°)
      loadProductsFromDB();
      
      // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
      const chatWindow = document.getElementById('chatWindow');
      const chatHeader = chatWindow.querySelector('.chat-header');
      const chatButton = document.getElementById('chatBtn');
      makeDraggable(chatWindow, chatHeader, null);
      makeDraggable(chatButton, chatButton, toggleChat);
      // ---------------------------------
    };
    
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function makeDraggable(element, handle, onClickCallback) {
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      let dragged = false; 
      handle.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e = e || window.event; e.preventDefault(); 
        dragged = false; pos3 = e.clientX; pos4 = e.clientY;
        if (element.style.top === "" || element.style.left === "") {
          const rect = element.getBoundingClientRect();
          element.style.top = rect.top + 'px';
          element.style.left = rect.left + 'px';
          element.style.bottom = 'auto'; element.style.right = 'auto';
        }
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
        handle.style.cursor = 'grabbing'; 
      }

      function elementDrag(e) {
        e = e || window.event; e.preventDefault();
        dragged = true; 
        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
        pos3 = e.clientX; pos4 = e.clientY;
        let newTop = element.offsetTop - pos2;
        let newLeft = element.offsetLeft - pos1;
        if (newTop < 0) newTop = 0;
        if (newLeft < 0) newLeft = 0;
        if (newTop + element.clientHeight > window.innerHeight) newTop = window.innerHeight - element.clientHeight;
        if (newLeft + element.clientWidth > window.innerWidth) newLeft = window.innerWidth - element.clientWidth;
        element.style.top = newTop + "px";
        element.style.left = newLeft + "px";
      }

      function closeDragElement() {
        document.onmouseup = null; document.onmousemove = null;
        handle.style.cursor = 'grab'; 
        if (!dragged && onClickCallback) { onClickCallback(); }
      }
    }
    // --- (‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å) ---


    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    let currentUserData = {};
    async function loadUserProfile(user) {
      const doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) { currentUserData = doc.data(); } 
      else {
        currentUserData = {
          displayName: user.displayName || user.email.split('@')[0],
          photoURL: user.photoURL || 'https://via.placeholder.com/150?text=User',
          email: user.email
        };
      }
      updateProfileUI();
    }
    function updateProfileUI() {
      document.getElementById('headerName').innerText = currentUserData.displayName;
      document.getElementById('headerAvatar').src = currentUserData.photoURL;
      document.getElementById('editName').value = currentUserData.displayName;
      document.getElementById('editEmail').value = currentUserData.email;
      document.getElementById('editAvatarPreview').src = currentUserData.photoURL;
      document.getElementById('custName').value = currentUserData.displayName;
    }
    function openProfileModal() { document.getElementById('profileModal').style.display = 'flex'; }
    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('editAvatarPreview').src = e.target.result; };
        reader.readAsDataURL(file);
      }
    }
    async function saveProfile() {
      const newName = document.getElementById('editName').value.trim();
      const newImgSrc = document.getElementById('editAvatarPreview').src;
      if(!newName) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', true);
      try {
        await db.collection('users').doc(userId).set({
          displayName: newName, photoURL: newImgSrc, email: currentUserData.email
        }, { merge: true });
        currentUserData.displayName = newName;
        currentUserData.photoURL = newImgSrc;
        updateProfileUI();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        closeModal('profileModal');
      } catch(e) { console.error(e); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true); }
    }
    function openLogoutConfirm() {
      document.getElementById('confirmIcon').innerHTML = 'üö™';
      document.getElementById('confirmTitle').innerText = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?';
      document.getElementById('confirmDesc').innerText = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';
      const btnConfirm = document.getElementById('btnConfirmAction');
      btnConfirm.innerText = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
      btnConfirm.onclick = () => {
        auth.signOut().then(() => {
          localStorage.removeItem('shop_userId');
          window.location.href = 'index.html';
        });
      };
      document.getElementById('confirmModal').style.display = 'flex';
    }
    // --- (‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå) ---


    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    async function checkAndSeedData() {
      const s = await db.collection('products').limit(1).get();
      if(s.empty) {
        console.log("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...");
        const b = db.batch();
        const categories = ['‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô', '‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á', '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö']; 
        categories.forEach(c => {
          let keyword = 'item'; 
          if (c === '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô') keyword = 'shirt';
          if (c === '‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á') keyword = 'jeans';
          if (c === '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î') keyword = 'hoodie';
          if (c === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö') keyword = 'jewelry';
          for(let i=1;i<=20;i++) {
            b.set(db.collection('products').doc(), {
              name: `${c} ${i}`, 
              price: Math.floor(Math.random()*500)+100, 
              stock: 20, 
              category: c, 
              image: `https://source.unsplash.com/300x300/?${keyword}&sig=${i}`, 
              sold: 0
            });
          }
        });
        await b.commit();
        console.log("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 80 ‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
      }
    }
    // --- (‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) ---
    

    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function loadProductsFromDB() { db.collection('products').onSnapshot(s => { allProducts=[]; s.forEach(d=>allProducts.push({id:d.id,...d.data()})); renderProducts(allProducts); }); }
    function renderProducts(p) {
      const c = document.getElementById('productList'); c.innerHTML='';
      p.forEach(x => {
        const isOut = x.stock <= 0;
        const stockText = isOut ? '<span style="color:var(--primary);">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${x.stock} ‡∏ä‡∏¥‡πâ‡∏ô`;
        const soldText = `‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${x.sold || 0} ‡∏ä‡∏¥‡πâ‡∏ô`;
        const isFav = userFavorites.includes(x.id);

        c.innerHTML += `
          <div class="product-card">
            <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${x.id}')"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button>
            <img src="${x.image}" class="p-img">
            <div class="p-details">
              <div><div class="p-name">${x.name}</div><div class="p-stock">${stockText} | ${soldText}</div></div>
              <div><div class="p-price">‡∏ø${x.price}</div><button class="p-btn" onclick="openQtyModal('${x.id}')" ${isOut?'disabled':''}>${isOut?'‡∏´‡∏°‡∏î':'‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'}</button></div>
            </div>
          </div>`;
      });
    }
    async function loadFavorites() {
       const doc = await db.collection('favorites').doc(userId).get();
       userFavorites = doc.exists ? (doc.data().ids || []) : [];
       renderProducts(allProducts);
    }
    async function toggleFav(id) {
       const idx = userFavorites.indexOf(id);
       if(idx > -1) { userFavorites.splice(idx, 1); showToast('‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö'); } 
       else { userFavorites.push(id); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö'); }
       const btns = document.querySelectorAll(`.fav-btn[onclick="toggleFav('${id}')"]`);
       btns.forEach(btn => {
         if(userFavorites.includes(id)) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-heart"></i>'; } 
         else { btn.classList.remove('active'); btn.innerHTML = '<i class="far fa-heart"></i>'; }
       });
       await db.collection('favorites').doc(userId).set({ ids: userFavorites });
    }
    function openFav() {
      document.getElementById('favModal').style.display = 'flex';
      const con = document.getElementById('favContainer');
      con.innerHTML = '';
      const favItems = allProducts.filter(p => userFavorites.includes(p.id));
      if(favItems.length === 0) return con.innerHTML = '<div class="empty-fav">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</div>';
      favItems.forEach(x => {
        con.innerHTML += `<div class="product-card"><button class="fav-btn active" onclick="toggleFav('${x.id}'); openFav();"><i class="fas fa-heart"></i></button><img src="${x.image}" class="p-img"><div class="p-details"><div class="p-name">${x.name}</div><div class="p-price">‡∏ø${x.price}</div><button class="p-btn" onclick="openQtyModal('${x.id}'); closeModal('favModal');">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button></div></div>`;
      });
    }
    function filterCategory(c,el) { document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); renderProducts(c==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'?allProducts:allProducts.filter(x=>x.category===c)); }
    function filterProducts() { const t=document.getElementById('searchInput').value.toLowerCase(); renderProducts(allProducts.filter(x=>x.name.toLowerCase().includes(t))); }
    function openQtyModal(id) {
      const p = allProducts.find(x=>x.id===id);
      if(!p || p.stock<=0) return;
      currentSelectedId=id; currentQty=1;
      document.getElementById('qtyImg').src=p.image;
      document.getElementById('qtyName').innerText=p.name;
      document.getElementById('qtyPrice').innerText='‡∏ø'+p.price;
      document.getElementById('qtyStock').innerText='‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: '+p.stock;
      document.getElementById('qtyDisplay').value=1;
      document.getElementById('qtyModal').style.display='flex';
    }
    function changeQty(n) {
      const p = allProducts.find(x=>x.id===currentSelectedId);
      if(currentQty+n >=1 && currentQty+n <= p.stock) { currentQty+=n; document.getElementById('qtyDisplay').value=currentQty; }
    }
    
    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function submitToCart() {
      const p = allProducts.find(x=>x.id===currentSelectedId);
      const ex = cart.find(x=>x.id===currentSelectedId);
      if(ex) {
        if(ex.qty+currentQty <= p.stock) ex.qty+=currentQty;
        else { ex.qty = p.stock; showToast('‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', true); }
      } else cart.push({...p, qty:currentQty});
      updateCart(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); closeModal('qtyModal');
    }
    function adjustCartQty(idx, change) {
      const item = cart[idx];
      const product = allProducts.find(p => p.id === item.id);
      const maxStock = product ? product.stock : item.qty; 
      let newQty = item.qty + change;
      if(newQty > maxStock) { newQty = maxStock; showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î ' + maxStock + ' ‡∏ä‡∏¥‡πâ‡∏ô', true); }
      if(newQty < 1) newQty = 1;
      cart[idx].qty = newQty;
      openCart(); updateCart();
    }
    function updateCart() { document.getElementById('cartCount').innerText=cart.reduce((a,b)=>a+b.qty,0); }


    // üî• 3. JS: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î üî•
    async function applyCoupon() {
      const codeInput = document.getElementById('couponInput');
      const code = codeInput.value.trim().toUpperCase(); // ‡πÉ‡∏ä‡πâ .toUpperCase() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å-‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ
      if (!code) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î', true);

      const btn = document.getElementById('couponBtn');
      btn.disabled = true;
      btn.innerText = '‡∏£‡∏≠...';

      try {
        // (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏ö‡∏ö Hardcode ‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô)
        // ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á Collection 'coupons' ‡πÉ‡∏ô Firestore ‡πÄ‡∏≠‡∏á
        const couponRef = db.collection('coupons').doc(code);
        const couponDoc = await couponRef.get();

        if (!couponDoc.exists) {
          showToast('‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
          currentDiscount = { code: null, type: null, value: 0 }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        } else {
          const couponData = couponDoc.data();
          
          // (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
          
          showToast('‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          currentDiscount = { code: code, ...couponData }; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        }
      } catch (e) {
        console.error("Error applying coupon:", e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true);
        currentDiscount = { code: null, type: null, value: 0 };
      } finally {
        btn.disabled = false;
        btn.innerText = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î';
        openCart(); // üî• ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å openCart() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà
      }
    }


    // üî• 4. JS: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç openCart() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î üî•
    function openCart() {
      const c = document.getElementById('cartItemsContainer'); 
      c.innerHTML = cart.length ? '' : '<p>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
      
      subtotalAmount = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢
      cart.forEach((x,i) => { 
        subtotalAmount += (x.price * x.qty); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢
        c.innerHTML+=`
          <div class="cart-item">
            <div class="cart-item-info">
              <b>${x.name}</b><br>
              <span style="color:var(--primary);">‡∏ø${x.price}</span>
              <div class="mini-qty-box">
                <button class="mini-qty-btn" onclick="adjustCartQty(${i}, -1)">-</button>
                <span class="mini-qty-val">${x.qty}</span>
                <button class="mini-qty-btn" onclick="adjustCartQty(${i}, 1)">+</button>
              </div>
            </div>
            <div class="cart-item-controls">
               <b style="margin-right:10px;">‡∏ø${x.price*x.qty}</b>
               <button onclick="cart.splice(${i},1);openCart();updateCart()" style="border:none;background:none;color:#999;cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
          </div>`; 
      });

      // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ---
      discountApplied = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
      const discountDisplay = document.getElementById('discountDisplay');

      if (currentDiscount.code && subtotalAmount > 0) {
        if (currentDiscount.type === 'percent') {
          // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏ö %
          discountApplied = (subtotalAmount * currentDiscount.value) / 100;
        } else if (currentDiscount.type === 'fixed') {
          // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
          discountApplied = currentDiscount.value;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
        if (discountApplied > subtotalAmount) {
          discountApplied = subtotalAmount;
        }
        
        finalTotalAmount = subtotalAmount - discountApplied; // ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        document.getElementById('couponCodeDisplay').innerText = currentDiscount.code;
        document.getElementById('discountAmount').innerText = `-‡∏ø${discountApplied.toFixed(0)}`; // .toFixed(0) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
        discountDisplay.style.display = 'flex';
      } else {
        finalTotalAmount = subtotalAmount; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        discountDisplay.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô UI ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°
      document.getElementById('subTotalPrice').innerText = '‡∏ø' + subtotalAmount;
      document.getElementById('totalPrice').innerText = '‡∏ø' + finalTotalAmount;
      
      document.getElementById('cartModal').style.display='flex';
    }

    
    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function openPayment() { 
      if(!cart.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', true);
      document.getElementById('cartModal').style.display='none'; 
      document.getElementById('paymentModal').style.display='flex'; 
    }
    function toggleBank(s) { document.getElementById('bankDetails').style.display=s?'block':'none'; if(!s) document.getElementById('bankSelect').value=''; }
    function showQR() {
      const b=document.getElementById('bankSelect').value;
      document.getElementById('qrCodeContainer').style.display=b?'block':'none';
      if(b) document.getElementById('qrImage').src=`https://promptpay.io/0970482500/${finalTotalAmount}`; // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô finalTotalAmount
    }
    

    // üî• 5. JS: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç confirmOrder() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î üî•
    async function confirmOrder() {
      const n=document.getElementById('custName').value, p=document.getElementById('custPhone').value, a=document.getElementById('custAddress').value;
      const pm=document.querySelector('input[name="payment"]:checked').value;
      const bankSelect = document.getElementById('bankSelect');
      const bankName = bankSelect ? bankSelect.value : '';

      if(!n||!p||!a) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
      if (pm === 'bank' && !bankName) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', true);

      const btn=document.getElementById('confirmPayBtn'); btn.disabled=true; btn.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      try {
        await Promise.all(cart.map(i => db.runTransaction(async t => {
          const d = await t.get(db.collection('products').doc(i.id));
          if(!d.exists) throw "Err";
          t.update(db.collection('products').doc(i.id), {stock:d.data().stock-i.qty, sold:(d.data().sold||0)+i.qty});
        })));
        
        // üî• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏•‡∏á‡πÉ‡∏ô Order
        await db.collection('orders').add({
          customer:{name:n,phone:p,address:a}, 
          items:cart, 
          subtotal: subtotalAmount, // ‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î
          discount: discountApplied, // ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
          coupon: currentDiscount.code || '-', // ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
          total: finalTotalAmount, // ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
          paymentMethod:pm, 
          bank:pm==='bank'?bankName:'-', 
          user:userId, 
          status:'pending', 
          timestamp:firebase.firestore.FieldValue.serverTimestamp()
        });
        
        sendMsgInternal(`[‡∏£‡∏∞‡∏ö‡∏ö] ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏¢‡∏≠‡∏î ‡∏ø${finalTotalAmount}`); // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
        
        cart=[]; // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        currentDiscount = { code: null, type: null, value: 0 }; // üî• ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        document.getElementById('couponInput').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á
        
        updateCart(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏î‡∏á
        closeModal('paymentModal');
        document.getElementById('successModal').style.display = 'flex';
      } catch(e){ 
        console.error("Order failed: ", e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true); 
      } finally { 
        btn.disabled=false; btn.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"; 
      }
    }

    
    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    async function openHistory() {
      document.getElementById('historyModal').style.display = 'flex';
      const con = document.getElementById('historyContainer');
      con.innerHTML = '<p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
      const s = await db.collection('orders').where('user', '==', userId).get();
      if(s.empty) return con.innerHTML = '<p style="text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';
      let ords = []; s.forEach(d => ords.push(d.data()));
      ords.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
      con.innerHTML = '';
      ords.forEach(o => {
        let items = ''; o.items.forEach(i => items += `<div class="item-row"><span>${i.name} x${i.qty}</span><span>‡∏ø${i.price*i.qty}</span></div>`);
        // üî• ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Total) ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ 'orange' ‡πÄ‡∏õ‡πá‡∏ô 'var(--primary)'
        con.innerHTML += `<div class="order-card"><div class="order-header"><span>üìÖ ${o.timestamp?new Date(o.timestamp.seconds*1000).toLocaleString('th-TH'):'-'}</span><span class="order-status" style="color:${o.status==='completed'?'green':'var(--primary)'}">${o.status==='completed'?'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'}</span></div><div class="order-items">${items}</div><div class="order-total">‡∏£‡∏ß‡∏°: ‡∏ø${o.total}</div></div>`;
      });
    }
    function toggleChat() { const w=document.getElementById('chatWindow'); w.style.display=w.style.display==='none'?'flex':'none'; if(w.style.display==='flex') scrollToBottom(); }
    function scrollToBottom() { const b=document.getElementById('chatBody'); b.scrollTop=b.scrollHeight; }
    function handleEnter(e) { if(e.key==='Enter') sendMsg(); }
    function sendMsg() {
      const txt = document.getElementById('msgInput').value.trim();
      if(!txt) return;
      document.getElementById('msgInput').value = '';
      sendMsgInternal(txt);
    }
    function sendMsgInternal(text) {
      db.collection('chats').doc(userId).collection('messages').add({ text: text, sender: 'user', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      db.collection('chats').doc(userId).set({ lastMessage: text, lastActive: firebase.firestore.FieldValue.serverTimestamp(), userId: userId, email: document.getElementById('custName').value || 'Guest' }, { merge: true });
      setTimeout(() => autoReply(text), 1000);
    }
    function autoReply(t) {
      let r=''; t=t.toLowerCase();
      if(t.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ')) r='‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö';
      if(r) {
         db.collection('chats').doc(userId).collection('messages').add({text:r, sender:'admin', timestamp:firebase.firestore.FieldValue.serverTimestamp()});
         db.collection('chats').doc(userId).set({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }
    }
    function listenToChat() {
      db.collection('chats').doc(userId).collection('messages').orderBy('timestamp').onSnapshot(s => {
        const b=document.getElementById('chatBody'); b.innerHTML='<div class="msg msg-admin">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö!</div>';
        s.forEach(d=> b.innerHTML+=`<div class="msg ${d.data().sender==='user'?'msg-user':'msg-admin'}">${d.data().text}</div>`);
        scrollToBottom();
      });
    }
    function closeModal(id){document.getElementById(id).style.display='none';}
    function showToast(text, isError = false){
      const t=document.getElementById('toast');
      t.querySelector('span').innerText = text;
      if(isError) {
        t.classList.add('error');
        t.querySelector('i').className = "fas fa-exclamation-circle";
      } else {
        t.classList.remove('error');
        t.querySelector('i').className = "fas fa-check-circle";
      }
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>